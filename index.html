<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mates: Mode Campanya</title>
    <style>
        :root { --primary: #4f46e5; --success: #22c55e; --error: #ef4444; --bg: #f8fafc; --warning: #f59e0b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; }
        .container { max-width: 950px; margin: 0 auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        /* Stats Bar con Progreso */
        .stats-bar { display: grid; grid-template-columns: 1.5fr 1fr 1.5fr; align-items: center; background: #1e293b; color: white; padding: 15px 25px; border-radius: 12px; margin-bottom: 20px; border-bottom: 4px solid var(--primary); }
        .timer-container { text-align: center; }
        .timer-bar { width: 100%; height: 8px; background: #475569; border-radius: 4px; margin-top: 5px; overflow: hidden; }
        #timerProgress { width: 100%; height: 100%; background: var(--success); transition: width 0.5s linear; }
        .time-val { font-weight: bold; font-family: monospace; font-size: 1.4rem; color: #fbbf24; }

        .score-info { display: flex; flex-direction: column; }
        .current-level-tag { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; }
        .score { font-size: 1.3rem; font-weight: bold; }
        .lives { text-align: right; color: #fb7185; font-size: 1.5rem; letter-spacing: 2px; }

        /* Pantalla de Transició */
        #msgOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(30, 41, 59, 0.9); z-index: 100; color: white; justify-content: center; align-items: center; flex-direction: column; text-align: center; }
        .msg-btn { margin-top: 20px; padding: 15px 40px; background: var(--primary); border: none; color: white; border-radius: 10px; cursor: pointer; font-size: 1.2rem; font-weight: bold; }

        /* Taula */
        table { width: 100%; border-collapse: separate; border-spacing: 5px; margin-top: 10px; }
        th { background: #f1f5f9; padding: 12px; border-radius: 8px; font-size: 0.85rem; color: #475569; }
        td { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; text-align: center; height: 55px; }
        .num-cell { font-weight: bold; font-size: 1.3rem; background: #f8fafc; color: #1e293b; width: 110px; }

        .check-cell { cursor: pointer; font-weight: bold; font-size: 1.2rem; color: transparent; transition: 0.2s; }
        .check-cell.correct { background: #dcfce7 !important; color: #166534 !important; border-color: var(--success); }
        .check-cell.wrong { background: #fee2e2 !important; color: #991b1b !important; border-color: var(--error); animation: shake 0.3s; }

        .explanation-box { background: #fffbeb; border: 1px solid #fde68a; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: none; }
        .rule-hint { font-size: 0.75rem; color: #64748b; font-weight: normal; margin-top: 4px; line-height: 1.1; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body>

<div id="msgOverlay">
    <h1 id="msgTitle">NIVELL SUPERAT!</h1>
    <p id="msgBody">Preparat per al següent repte?</p>
    <button class="msg-btn" onclick="startNextLevel()">CONTINUAR</button>
</div>

<div class="container">
    <div class="stats-bar">
        <div class="score-info">
            <span class="current-level-tag" id="levelName">NIVELL: MITJÀ</span>
            <div class="score">Punts: <span id="scoreVal">0</span></div>
            <div style="font-size: 0.8rem; color: #94a3b8;">Restants: <span id="remainingCount" style="color:#fbbf24">0</span></div>
        </div>
        <div class="timer-container">
            <div class="time-val" id="timeDisplay">00:45</div>
            <div class="timer-bar"><div id="timerProgress"></div></div>
        </div>
        <div class="lives" id="livesDisplay">❤️❤️❤️</div>
    </div>

    <div id="explanation" class="explanation-box"></div>

    <table id="gameTable">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    const rules = {
        2: "Parell.", 3: "Suma de xifres.", 4: "Últimes 2 xifres.", 5: "Acaba en 0 o 5.",
        6: "Divisible per 2 i 3.", 7: "Algorisme del 7.", 8: "Últimes 3 xifres.", 9: "Suma xifres = 9.",
        10: "Acaba en 0.", 11: "Resta parell/imparell.", 12: "Divisible per 3 i 4."
    };

    const levelConfigs = [
        { id: 'MITJÀ', divs: [2, 3, 5, 10], time: 45 },
        { id: 'AVANÇAT', divs: [3, 4, 6, 12], time: 40 },
        { id: 'PRO', divs: [7, 8, 9, 11], time: 35 }
    ];

    let state = {
        lives: 3,
        score: 0,
        levelIdx: 0,
        remaining: 0,
        timeLeft: 45,
        timerId: null,
        isPaused: false
    };

    function startTimer() {
        if (state.timerId) clearInterval(state.timerId);
        state.timerId = setInterval(() => {
            if (state.isPaused) return;
            state.timeLeft--;
            updateTimerUI();
            if (state.timeLeft <= 0) {
                clearInterval(state.timerId);
                handleTimeOut();
            }
        }, 1000);
    }

    function updateTimerUI() {
        const display = document.getElementById('timeDisplay');
        const progress = document.getElementById('timerProgress');
        const maxTime = levelConfigs[state.levelIdx].time;
        const percent = (state.timeLeft / maxTime) * 100;
        
        display.innerText = `00:${state.timeLeft < 10 ? '0' : ''}${state.timeLeft}`;
        progress.style.width = Math.max(0, percent) + "%";
        
        if (percent < 30) progress.style.background = "var(--error)";
        else if (percent < 60) progress.style.background = "var(--warning)";
        else progress.style.background = "var(--success)";
    }

    function handleTimeOut() {
        state.lives--;
        updateStats();
        if (state.lives > 0) {
            showOverlay("TEMPS EXHAURIT!", "Has perdut una vida. Reintentant nivell...", "REINTENTAR");
        }
    }

    function showOverlay(title, body, btnText) {
        state.isPaused = true;
        document.getElementById('msgOverlay').style.display = 'flex';
        document.getElementById('msgTitle').innerText = title;
        document.getElementById('msgBody').innerText = body;
        document.querySelector('.msg-btn').innerText = btnText;
    }

    function startNextLevel() {
        document.getElementById('msgOverlay').style.display = 'none';
        state.isPaused = false;
        renderTable();
    }

    function updateStats() {
        document.getElementById('scoreVal').innerText = state.score;
        document.getElementById('livesDisplay').innerText = "❤️".repeat(state.lives);
        document.getElementById('remainingCount').innerText = state.remaining;
        document.getElementById('levelName').innerText = "NIVELL: " + levelConfigs[state.levelIdx].id;
        
        if (state.lives <= 0) {
            clearInterval(state.timerId);
            showOverlay("GAME OVER", `Has arribat al nivell ${levelConfigs[state.levelIdx].id} amb ${state.score} punts.`, "TORNAR A COMENÇAR");
            state.lives = 3;
            state.score = 0;
            state.levelIdx = 0;
        }
    }

    function renderTable() {
        const config = levelConfigs[state.levelIdx];
        const head = document.getElementById('tableHead');
        const body = document.getElementById('tableBody');
        
        head.innerHTML = `<tr><th>Número</th>${config.divs.map(d => `<th>${d}<div class="rule-hint">${rules[d]}</div></th>`).join('')}</tr>`;
        body.innerHTML = '';
        
        state.remaining = 0;
        state.timeLeft = config.time;
        document.getElementById('explanation').style.display = 'none';

        for (let i = 0; i < 5; i++) {
            let num = Math.floor(Math.random() * 4000) + 11;
            config.divs.forEach(d => { if (num % d === 0) state.remaining++; });
            let row = document.createElement('tr');
            row.innerHTML = `<td class="num-cell">${num}</td>` + config.divs.map(d => `
                <td class="check-cell" onclick="handleCheck(this, ${num}, ${d})">?</td>
            `).join('');
            body.appendChild(row);
        }
        updateStats();
        startTimer();
    }

    function handleCheck(el, num, div) {
        if (state.lives <= 0 || state.isPaused || el.classList.contains('correct') || el.classList.contains('wrong')) return;

        if (num % div === 0) {
            el.classList.add('correct');
            el.innerText = "✓";
            state.score += 10;
            state.timeLeft = Math.min(state.timeLeft + 2, levelConfigs[state.levelIdx].time); // Bonus de temps!
            state.remaining--;
            
            if (state.remaining === 0) {
                clearInterval(state.timerId);
                const isLast = state.levelIdx === levelConfigs.length - 1;
                if (isLast) {
                    state.score += 100; // Bonus final
                    showOverlay("CAMPIONS!", "Has superat tots els nivells del Laboratori!", "JUGAR DE NOU");
                    state.levelIdx = 0;
                } else {
                    state.levelIdx++;
                    showOverlay("NIVELL SUPERAT!", `Bonus de +50 punts! Passem al nivell ${levelConfigs[state.levelIdx].id}`, "SEGUENT NIVELL");
                    state.score += 50;
                }
            }
        } else {
            el.classList.add('wrong');
            el.innerText = "✗";
            state.lives--;
            const expBox = document.getElementById('explanation');
            expBox.style.display = 'block';
            expBox.innerHTML = `<strong>Error!</strong> ${num} no és divisible per ${div}. <small>${rules[div]}</small>`;
        }
        updateStats();
    }

    renderTable();
</script>
</body>
</html>
